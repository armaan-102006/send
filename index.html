<!DOCTYPE html>
<html>
<head><title>Send My Location</title></head>
<body>
<button onclick="start()">Start Sending Location</button>

<script>
let socket, watchId;

function start() {
  navigator.permissions.query({name:'geolocation'}).then(function(result) {
    if (result.state === 'granted') {
      // Permission already granted, start watching without prompt
      startWatchPosition();
    } else if (result.state === 'prompt') {
      // First time, will prompt
      startWatchPosition();
    } else if (result.state === 'denied') {
      alert('Geolocation permission denied. Please enable it manually.');
    }

    // Listen to permission state changes
    result.onchange = function() {
      if (result.state === 'granted') {
        startWatchPosition();
      }
    };
  });
}

function startWatchPosition() {
  socket = new WebSocket('ws://366c7cb5c730.ngrok-free.app/bus');// put ur own ip

  socket.onopen = () => {
    watchId = navigator.geolocation.watchPosition(
      (pos) => {
        if (socket.readyState === WebSocket.OPEN) {
          socket.send(JSON.stringify({
            latitude: pos.coords.latitude,
            longitude: pos.coords.longitude,
            accuracy: pos.coords.accuracy,
            speed: pos.coords.speed
          }));
        }
      },
      (err) => {
        console.error('Geolocation error:', err);
      },
      { enableHighAccuracy: true }
    );
  };

  socket.onclose = () => {
    if (watchId) navigator.geolocation.clearWatch(watchId);
  };

  socket.onerror = (err) => {
    console.error('WebSocket error:', err);
  };
}

</script>

</body>
</html>
